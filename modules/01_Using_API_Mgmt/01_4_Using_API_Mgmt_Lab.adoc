:scrollbar:
:data-uri:
:toc2:
:numbered:


= Using Red Hat 3Scale API Management Lab

.Goals:

. Use the 3scale Admin Portal, REST APIs and Command Line Interface to manage RESTful APIs using the AMP hosted on OpenShift Container Platform.

.Prerequisites
* Completion of the previous labs of this course
* * The `OCP_WILDCARD_DOMAIN` environment variable set in your shell
+
TIP: To check if your shell still has this environment variable set, execute the `echo $OCP_WILDCARD_DOMAIN` command. If the variable is no longer set, return to the first lab in this course and follow the steps there to set it again.
+
* 3scale Admin Portal URL and user credentials to login.
+
IMPORTANT: The 3scale URL for your lab environment will be `https://3scale-admin.$OCP_WILDCARD_DOMAIN`. The userid/password is `admin/admin`.

== Overview

In the previous labs, you installed and configured an OpenShift Container Platform environment, installed the AMP On-premise, and RESTFul business services. In this lab, you install use the AMP to manage the RESTful business service APIs. 

Use your new on-premise 3scale by Red Hat AMP to manage and monitor your business services. A deployment topology of your two business service clients invoking your on-premise APIcast and AMP environment is as shown here:

image::images/on_prem_amp_host_routing.png[]

NOTE: The business services for Vertx and Swarm are the ones created in the earlier lab in the `bservices` project. Please confirm that the project exists and the services are available.

== Create Routes for Business Service APIs

You now have both APIcast and AMP environments installed on-premise in your OpenShift Container Platform lab environment.

. Open a browser window and navigate to the OpenShift Management Console URL
+
NOTE: The URL for Management Console is https://${EXTERNAL_HOST}:8443/
+
image::images/ocp_login.png[]
+
. Login as user `developer` with password `developer`. 
. Navigate to the `3scale-amp` project.
. Delete the out-of-the-box default routes that are assigned to both of your new `apicast` gateways.
.. Navigate to `Applications` -> `Routes`.
.. Delete the route `api-apicast-production-route`.
+
image::images/ocp_amp_delete_apicast_prod_route.png[]
+
.. Delete the route `api-apicast-staging-route`.
+
image::images/ocp_amp_delete_apicast_stage_route.png[]
+
. For each business service, create an HTTPS route for both of your new `apicast` gateways. 
.. For swarm, create the `swarm-stage-apicast` route for the staging environment.
+
image::images/ocp_amp_apicast_stage_swarm_route.png[]
+
.. Similarly, create the `swarm-prod-apicast` route for the production environment.
+
image::images/ocp_amp_apicast_prod_swarm_route.png[]
+
.. Repeat the process to create the `vertx-stage-apicast` and `vertx-prod-apicast` routes.
.. You should now have the following routes in your list:
+
image::images/ocp_amp_list_routes.png[]

== API Management Using 3scale AMP Admin Portal

Now, you will expose the VertX business services created in an earlier lab using the 3scale APICast Gateway. We will use the 3scale Admin Portal to create the accounts, applications, application plans, services and API definitions.


=== Login

. In a browser window, access the 3scale Admin Portal URL.
+
NOTE: The 3scale admin portal is as noted in the previous lab. It should be of the form https://3scale-admin.cloudapps.$GUID.3scale.opentlc.com, where $GUID is the unique GUID of your OPENTLC host.
+
. Login to the 3scale portal using credentials `admin/admin`.
+
image::images/3scale_amp_admin_portal_login.png[]
+
. Navigate to `Developers` and delete the default user `John Doe`.
+
image::images/3scale_amp_admin_delete_developers.png[]


=== Define accounts and users

. Create a new account `vertx_dev` with following credentials:
.. `Username`: `vertx_dev`
.. `Email` : PROVIDE A UNIQUE EMAIL ADDRESS
.. `PASSWORD`: PROVIDE A UNIQUE EASY TO REMEMBER PASSWORD
.. `Organization/Group Name` : `vertx_group`

=== Define VertX Service

In this section, you define a service that manages access to the Vertx business service that you provisioned in the previous lab.

. Navigate to the API tab.
. Create a new service with following information:
.. `Name` : `vertx_service`
.. `System Name` : `vertx_service`
.. `Authentication` : `API Key (user_key)`

=== Define Application Plan

. In the newly created `vertx_service`, create a new Application Plan.
. Use the following parameters:
.. `Name` : `vertx_app_plan`
.. `System Name` : `vertx_app_plan`

=== Create Application

In this section, you associate an application to your previously defined users. This generates a user key to the application. The user key is used as a query parameter to the HTTP request to invoke your business services via your on-premise APIcast gateway.

. Navigate to the `Developers` tab.
. Select the `vertx_account` and create a new application.
.. `Application Plan` : `vertx_app_plan`
.. `Service Plan` : `Default`
.. `Name`: `vertx_app`
.. `Description` : `Vertx business service application.`

. After the Application is created, make a note of the User Key.

=== Stage Vertx Service Integration

. Navigate to the API tab.
. In the `vertx_service`, select *Application Plans*.
. *Publish* the `vertx_app_plan`.
. In your `vertx_service`, select *Integration*.
. Enter the vertx API and Business Service routes to the configuration:
.. `Private Base URL` : _Route to the Vertx Business Service Endpoint_
+
image::images/ocp_bservices_vertx_route.png[]
+
.. `Staging Public Base URL` : _Route to the Vertx APICast Staging Endpoint_
+
image::images/ocp_amp_list_routes_highlight_vertx_stage.png[]
+
.. `Production Public Base URL` : _Route to the Vertx APICast Production Endpoint_
+
image::images/ocp_amp_list_routes_highlight_vertx_prod.png[]
+
.. Keep the rest of the configuration same and `Update & test in Staging Environment`.
.. `API test GET Request` : `/hello`

. Now make a request based on the curl request generated in the Client to ensure the staging API URL is accessed correctly.
. Once it is successful, `Promote to Production` and test the curl request for Production. 

== API Management Using 3scale REST APIs

In this lab, you will expose the WildFly Swarm business services created in an earlier lab using the 3scale APICast Gateway. We will use the REST API calls to create the accounts, applications, application plans, services and API definitions.


=== Identify Admin Access Token

You need the Admin Access Token for your new on-premise AMP environment. You use it when programmatically invoking the RESTful APIs of your 3scale by Red Hat on-premise AMP environment.

== API Management Using 3scale Command Line Interface (CLI)

[blue]#Congratulations!#.

ifdef::showscript[]
endif::showscript[]
