:scrollbar:
:data-uri:
:toc2:
:numbered:


= Custom Development Portal

In this lab, you will create APIdocs for the APIs managed by 3scale, learn about the developer portal and customization, and create a client application to consume the APIs exposed by 3scale.
 
.Goals
. Create API docs for the Products API application.
. Integrate the API docs with 3scale.
. Create a custom development portal
. Create a client application to call the Products API.

== API Documentation

In this lab, you will generate and test an ActiveDocs documentation for the API created in the previous module.

ActiveDocs is  not a Swagger replacement but an instantiation of it. With ActiveDocs, you don’t have to run your own Swagger server or deal with the UI components of the interactive documentation. The interactive documentation is served and rendered from your 3scale Developer Portal. For more information visit this link: https://support.3scale.net/docs/api-documentation/create-activedocs-spec

=== Create Swagger API Documentation

. In a new browser window, navigate to `http://editor.swagger.io/`
. Select *File -> Import URL*.
. Enter the URL of your business API swagger spec: *http://products-$OCP_PROJECT_PREFIX.$OCP_WILDCARD_DOMAIN/rest/swagger.yaml* 
+
IMPORTANT: Please note that the values will not be resolved on the browser, so you need to provide the full path, e.g http://products-sjayanti-redhat-com.apps.na1.openshift.opentlc.com:80/rest/swagger.yaml
+
. Click OK.
. In the YAML editor,make the following changes:
.. Line 6:  Change host to your products-apicast-staging route endpoint e.g *products-stage-apicast-sjayanti-redhat-com-3scale-amp.apps.na1.openshift.opentlc.com:443*
.. Line 11: Change scheme to *https*
.. Line 24: Add the following lines:
+
[source,YAML]
-----
        - name: "user_key"
          in: "query"
          type: string
          x-data-threescale-name: "user_keys"
          required: true      
-----
+
image::images/3scale_amp_products_swagger1.png[]
+
.. Line 50: repeat above step.
+
image::images/3scale_amp_products_swagger2.png[]
+
.. Line 74: repeat the above step.
.. Line 98: delete the curly brackets.
.. Line 99: repeat the step for adding user_key
+
[source,YAML]
-----
        - name: "user_key"
          in: "query"
          type: string
          x-data-threescale-name: "user_keys"
          required: true      
-----
+
image::images/3scale_amp_products_swagger3.png[]
+
. Click on `File -> Download JSON`.
+
image::images/3scale_amp_products_swagger4.png[]
+
. Save the JSON file to your disk.
. Close the browser tab.

=== Create ActiveDocs

. Login to your 3scale AMP management portal from the browser.
. Click on the `APIs` tab.
. Click on `ActiveDocs` link. 
+
image::images/3scale_amp_products_activedocs1.png[]
+
. Click on the `Create a new spec`.
+
image::images/3scale_amp_products_activedocs2.png[]
+
. Enter the following values:
.. *Name*: Products
.. *System Name*: products_spec
.. *Publish?*: checked
.. *Description*: Products API Documentation
+
image::images/3scale_amp_products_activedocs3.png[]
+
. Open the *swagger.json* created in the previous step in a text editor.
. Paste the contents of *swagger.json* to the `API JSON Spec` window:
+
image::images/3scale_amp_products_activedocs4.png[]
+
. Click on `Create Service`.
+
image::images/3scale_amp_products_activedocs5.png[]
+
. If the `Publish` link is showing in the top, click on the link.

=== Test the API ActiveDocs

. Click on the `Get all Products` link to expand the method.
. Go to the *Parameters* section.
. Click on the *user_key* value field.
. Select the *ProductsApp* user_key.
. Click on the `Try it out` button.
+
image::images/3scale_amp_products_activedocs6.png[]
+
. If you get a *No response from server* error from server, you need to accept the SSL certificate of the server.
.. Open the request  URL in a browser window and click on `proceed to URL` as shown below:
+
image::images/3scale_amp_products_activedocs7.png[]
+
. Now go back to the ActiveDocs and try the request again. It should return a HTTP 200 response and the response body as below.
+
image::images/3scale_amp_products_activedocs8.png[]


== Developer Portal Customization

In this lab you will work on the Developer Portal for the API’s customers/partners/users. 
The Developer portal can be fully customized to meet your needs.
You can find more information here: https://support.3scale.net/docs/developer-portal/overview 

=== Import Logo Files:

. Open a web browser and navigate to URL: https://github.com/gpe-mw-training/3scale_development_labs/tree/master/DevPortal
. Download the below 2 files locally:
.. RHMartBackground.jpg
.. RHMartLogo.png
. Now login to the 3scale AMP Portal with your userid/password.
. Click on the `Developer Portal` tab.
. Click on the arrow next to the `New Page` button.
. Click on `New File`.
+
image::images/3scale_amp_products_dev_portal1.png[]
+
. Enter the following:
.. *Section*: images
.. *Path*:  /images/RHMartLogo.png
.. *Attachment*: _Attach the file RHMartLogo.png from your localhost._
+
image::images/3scale_amp_products_dev_portal2.png[]
+
. Click on `Create File` button.
. Click on `New File`.
. Enter the following:
.. *Section*: images
.. *Path*:  /images/RHMartBackground.png
.. *Attachment*: _Attach the file RHMartBackground.png from your localhost._
+
image::images/3scale_amp_products_dev_portal3.png[]
+
. Click on `Create File` button.

=== Make Changes to the HTML/CSS

. Click on the *All* button.
. Click on the *Layouts* icon.
. Click on *Main Layout*.
+
image::images/3scale_amp_products_dev_portal4.png[]
+
. Go to line #46. delete this line:
+
[source,text]
-----
            <a class="navbar-brand" href="/">{{  provider.name }}</a>
-----
+
. Replace it with the following:
+
[source,text]
-----
            <div class="logo">
               <a href="#">
                  <img src="/images/RHMartLogo.png" alt="" style="height:100px; width:150px;">
               </a>
            </div>
-----
+
. Scroll down to the bottom of the page, and click on the *Save* button.
+
image::images/3scale_amp_products_dev_portal5.png[]
+
. Click on the Pages icon.
. Click on Documentation.
+
image::images/3scale_amp_products_dev_portal6.png[]
+
. Replace the contents of the page with the content from the gist: https://gist.githubusercontent.com/satyaj/dbafcfafd2d9271f68ad05c0b6026559/raw/1cdf95678ada83bf524230c168920c6461345585/docs.html
+
. Click on *Save* button.
+
image::images/3scale_amp_products_dev_portal7.png[]
+
. Click on *Homepage*
+
image::images/3scale_amp_products_dev_portal8.png[]
+
. Go to the HTML editor, and perform a search and replace of “Echo” (with capital “E”) to “RHMart” in lines #19, #98 and #112.
. Go to line #5.
. Replace it with the following:
+
[source,text]
-----
            <h1 style="text-shadow: 4px 4px #000000;">RH Mart API</h1>
-----
+
. Click on *Save* button.
. Click on *default.css*, under the css folder.
+
image::images/3scale_amp_products_dev_portal9.png[]
+
. Go to line #22.
. Replace it with the following:
+
[source,text]
-----
            background-image: url('/images/RHMartBackground.jpg');
-----
+
. Scroll down to the bottom of the page.
. Click on the *Save* button.
. Click on the *0 Drafts* tab.
. Click on *Publish All*.
+
image::images/3scale_amp_products_dev_portal10.png[]
+
. In the pop-up window confirming the changes, click *OK* button.


=== Test the changes

. Click on the *Visit Developer Portal* button.
+
image::images/3scale_amp_products_dev_portal11.png[]
+
. The developer portal opens in a new tab on your browser.
+
image::images/3scale_amp_products_dev_portal12.png[]
+
. Click on *SIGN IN* on the top right.
. Login as `rhbankdev` and the password provided in the previous lab.
. Once logged in, you will be directed to the homepage.
+
image::images/3scale_amp_products_dev_portal13.png[]
+
. Explore the sections such as *Applications*, *Statistics* and *Credentials*.
. Click on *Documentation*. Notice that the ActiveDocs created earlier are shown here.
. You can choose to test the API requests from this page.
+
image::images/3scale_amp_products_dev_portal14.png[]


== Private Portal for Admins

==== Create Admin account application using `ProductsPremiumPlan` 

Recall that in Module 1, you set up the `rhbankdev` user as part of the `RHBank` group. 
While creating the rate limits, we have disabled the methods `Create Account` and `Delete Account`, so a request for either of these methods should result in a *HTTP 403: Not Authorized* error.

In this section, follow the same steps and create a new user called `rhadmin` and assign that user as part of a `RHAdmin` group
Afterwards, create an Application using the `ProductsPremiumPlan` Application Plan

Once the new application plan is created, try the `Create Account` and `Delete Account` requests using the *user_key* generated for this account.

Example request for `Create Account`:

[source,text]
-----
$ curl -k -X POST --header "Content-Type: application/json" --header "Accept: application/json" -d "{                     
  \"productid\": null,
  \"productname\": \"Samsung LED TV\",
  \"productprice\": 499.95}" "https://products-stage-apicast-sjayanti-redhat-com-3scale-amp.apps.na1.openshift.opentlc.com:443/rest/services/product?user_key=6e1bec836da1b3705da23635823f4f2d"

-----

The response should be as below:

[source,text]
-----
{"message":"Product created"}
-----

Example request for `Delete Account`

[source,text]
-----
$ curl -k -X DELETE --header "Accept: application/json" "https://products-stage-apicast-sjayanti-redhat-com-3scale-amp.apps.na1.openshift.opentlc.com:443/rest/services/product/13?user_key=6e1bec836da1b3705da23635823f4f2d"

-----

The response should be as below:

[source,text]
-----
{"message":"Product 13 deleted"}
-----


=== Create Admin Section & Groups in Dev Portal

In this section of the lab, we will create a private section of the portal for access by Admin users, create a group and associate it with the *ProductsPremiumApp*.

. Login to the 3scale Admin Portal using your login credentials.
. Click on the *Developer Portal* tab.
. Click on *New Section*
+
image::images/3scale_amp_products_dev_portal_groups_1.png[]
+
. In the *New Section* form, provide the following information:
.. *Title*: admin
.. *Parent*: Root
.. *Partial Path*: /rhadmin
+
image::images/3scale_amp_products_dev_portal_groups_2.png[]
+
. Ensure the *public* button is unchecked and click on `Create Section`.
. Your new section will appear in the main menu.
+
image::images/3scale_amp_products_dev_portal_groups_3.png[]
+
. Now click and select *New Page*.
+
image::images/3scale_amp_products_dev_portal_groups_4.png[]
+
. In the *New Page* form, enter the following values:
.. *Title*: Admin Page
.. *Section*: admin
.. *Path*: /rhadmin/welcome
.. *Liquid Enabled*: checked
.. Enter the following text in the text box:
+
[source,text]
-----
<h2>Administration Portal</h2>

Hello <B>{{ current_user.username }}</B>, you are an Admin user of  <B>Account organization  {{ current_account.name }}</B>.

Welcome to the Administration Section of the portal.
-----
+
image::images/3scale_amp_products_dev_portal_groups_5.png[]
+
. Click on `Create Page`.
. You should see the `Welcome` page in the `admin` section on the menu.
+
image::images/3scale_amp_products_dev_portal_groups_6.png[]
+
. Scroll down to the *Partials* section of the menu and click on *submenu*.
+
image::images/3scale_amp_products_dev_portal_groups_7.png[]
+
. Add the following on line 38, after the *Documentation* item.
+
[source,text]
-----
        {% if current_account.name == 'RHAdmin'? %}
          <li class="{% if urls.docs.active? %}active{% endif %}">
            <a href="/rhadmin/welcome">Admin</a>
          </li>
        {% endif %}
-----
+
image::images/3scale_amp_products_dev_portal_groups_8.png[]
+
. Click on *Save*.
. Now click on *Drafts* tab on the top, and select *Publish All*.
+
image::images/3scale_amp_products_dev_portal_groups_9.png[]
+
. All your changes are now published and can be tested from the Developer Portal.

. Now click on *Groups*. 
. Click on *Create Group*.
+
image::images/3scale_amp_products_dev_portal_groups_10.png[]
+
. Enter the following values:
.. *Name*: RHAdmin
.. *Allowed Sections*: admin
. Click on *Create Group*.
. Now navigate to *Developers* section and click on *RHAdmin* account. 
+
TIP: This is the account you created in the previous lab to use the *ProductsPremiumPlan*.
+
. Click on the *O Group Memberships* breadcrumb.
+
image::images/3scale_amp_products_dev_portal_groups_11.png[]
+
. Select the *RHAdmin* group in the Groups list and click on *Save*.
+
image::images/3scale_amp_products_dev_portal_groups_13.png[]
+
. Now the configuration for Admin section and groups is complete and can be tested.

=== Test the Admin Group Section

. Open the Developer Portal and click on *Sign In*.
. Login as user *rhadmin* with the password you provided earlier.
+
image::images/3scale_amp_products_dev_portal_groups_12.png[]
+
. Observe that the *ADMIN* link appears on the top menu.
+
image::images/3scale_amp_products_dev_portal_groups_13.png[]
+
. Click on the *ADMIN* link and observe that the Administration portal page appears.
+
image::images/3scale_amp_products_dev_portal_groups_14.png[]
+
. Now logout from the portal by clicking on the logout icon.
+
image::images/3scale_amp_products_dev_portal_groups_15.png[]
+
. Login as user *rhbankdev* with the password provided during sign up.
. Observe that as this user is a basic user, the *ADMIN* link is not available.
+
image::images/3scale_amp_products_dev_portal_groups_16.png[]
+
. If the *rhbankdev* user tries to access the `/rhadmin/welcome` link directly, he would get an error message.
+
image::images/3scale_amp_products_dev_portal_groups_17.png[]


Thus, we can use Groups and private sections to control the access to certain sections of the Developer Portal, or to ensure that there are different sections or layouts that could be accessed depending on the user's role.

References: 

. https://support.3scale.net/docs/developer-portal/overview
. https://support.3scale.net/docs/developer-portal/liquid-reference

[blue]#Congratulations!#.

ifdef::showscript[]
endif::showscript[]
